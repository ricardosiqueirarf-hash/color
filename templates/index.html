<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orçamento de Portas</title>

<style>
body { margin:0; font-family:Arial, Helvetica, sans-serif; background:#f2f2f2; }
.app { display:grid; grid-template-columns:18% 82%; height:100vh; }
.sidebar { background:#1e1e1e; color:white; padding:20px; display:flex; flex-direction:column; gap:10px; }
.sidebar button { padding:10px; border:none; background:#333; color:white; border-radius:6px; cursor:pointer; }
.content { padding:25px; overflow-y:auto; height:100vh; }
.row { display:flex; gap:15px; flex-wrap:wrap; margin-top:10px; }
label { display:flex; flex-direction:column; font-size:0.9rem; width:180px; }
input, select { padding:7px; margin-top:5px; }
.btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; background:#0078d7; color:white; margin-top:10px; }
#formPorta, #formCliente { background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
table { border-collapse: collapse; width:100%; }
th, td { border:1px solid #ccc; padding:6px; }
th { background:#ddd; }
</style>
</head>

<body>

<div class="app">
    <div class="sidebar">
        <h3>ColorGlass</h3>
        <button onclick="go('/')">Home</button>
        <button onclick="go('/perfis-page')">Perfis</button>
        <button onclick="go('/vidros-page')">Vidros</button>
        <button onclick="go('/producao-page')">Produção</button>
        <button onclick="go('/insumos-page')">Insumos</button>
        <button onclick="go('/orcamentos-page')">Orçamentos</button>
    </div>

    <div class="content">
        <h1>Orçamentos</h1>

        <!-- CRIAR CLIENTE -->
        <div id="formCliente">
            <label>
                Nome do Cliente
                <input type="text" id="clienteNome">
            </label>
            <button class="btn" onclick="criarFichaCliente()">Criar Orçamento</button>
        </div>

        <!-- ORÇAMENTOS EXISTENTES -->
        <h2>Orçamentos Existentes</h2>
        <div id="orcamentosExistentes"><em>Carregando...</em></div>
    </div>
</div>

<script>
function go(p){ window.location.href = p }

// =====================
// LISTAR ORÇAMENTOS
// =====================
function carregarOrcamentos(){
    fetch("/api/orcamentos")
    .then(r=>r.json())
    .then(d=>{
        const container = document.getElementById("orcamentosExistentes")
        container.innerHTML = ""

        if(!d.orcamentos || d.orcamentos.length === 0){
            container.innerHTML = "<em>Nenhum orçamento encontrado</em>"
            return
        }

        const table = document.createElement("table")
        table.innerHTML = `
            <thead>
                <tr>
                    <th># Pedido</th>
                    <th>Cliente</th>
                    <th>Data</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        `
        const tbody = table.querySelector("tbody")

        d.orcamentos.forEach(o=>{
            const tr = document.createElement("tr")
            tr.innerHTML = `
                <td>${o.numero_pedido}</td>
                <td>${o.cliente_nome}</td>
                <td>${new Date(o.data_criacao).toLocaleString()}</td>
                <td>
                    <button class="btn" onclick="editarOrcamento('${o.id}')">
                        Editar
                    </button>
                </td>
            `
            tbody.appendChild(tr)
        })

        container.appendChild(table)
    })
}
carregarOrcamentos()

// =====================
// EDITAR ORÇAMENTO (SESSION)
// =====================
function editarOrcamento(uuid){
    fetch("/api/orcamento/set", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ uuid })
    }).then(()=>{
        window.location.href = "/portas-page"
    })
}

// =====================
// CRIAR ORÇAMENTO
// =====================
async function criarFichaCliente(){
    const nome = document.getElementById("clienteNome").value.trim()
    if(!nome){
        alert("Digite o nome do cliente")
        return
    }

    const res = await fetch("/api/orcamento", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ cliente_nome: nome })
    })

    const data = await res.json()
    if(data.success){
        editarOrcamento(data.id)
    } else {
        alert("Erro ao criar orçamento")
    }
}
</script>

</body>
</html>

